# IAM Service

An authentication service built for microservice architecture where tokens generated by the service can easily and safely be accepted by itself or other services within the system.

## Core Capabilities

### Authentication
- Enforces the use of strong passwords.
- Hashing of passwords for secure storage.
- JWT implementation using `RS256` with public-private key pair for secure token generation and verification.
- Standardized OAuth2 Bearer token scheme for authentication.
- Support for key rotation. Periodic key rotation is a security best practice.

### Authorization
- Supports Role Based Access Control (RBAC) with user and admin roles.
- Self-service registration.

### Audit
- Detailed audit logging of all API calls for security monitoring and forensic analysis.
- Helps monitor failed/succesful login attempts, client IPs, token IDs  etc.

## Run

### IAM Service
```bash
./run.sh
```

### Unit-tests
```bash
./run-tests.sh
```

<details>
  <summary>Expand to see test results</summary>

```bash
$ ./run-tests.sh
=============================================== test session starts ================================================
platform darwin -- Python 3.10.11, pytest-7.4.3, pluggy-1.6.0 -- iam-service/.venv/bin/python
cachedir: .pytest_cache
rootdir: iam-service
configfile: pytest.ini
plugins: asyncio-0.21.1, anyio-4.10.0
asyncio: mode=strict
collected 29 items

tests/test_auth.py::TestUserRegistration::test_user_registration_success PASSED                              [  3%]
tests/test_auth.py::TestUserRegistration::test_user_registration_duplicate_email PASSED                      [  6%]
tests/test_auth.py::TestUserRegistration::test_user_registration_short_password PASSED                       [ 10%]
tests/test_auth.py::TestUserRegistration::test_user_registration_invalid_email PASSED                        [ 13%]
tests/test_auth.py::TestUserRegistration::test_user_registration_missing_required_fields PASSED              [ 17%]
tests/test_auth.py::TestUserRegistration::test_user_registration_extra_fields_rejected PASSED                [ 20%]
tests/test_auth.py::TestUserLogin::test_login_success PASSED                                                 [ 24%]
tests/test_auth.py::TestUserLogin::test_login_invalid_credentials PASSED                                     [ 27%]
tests/test_auth.py::TestUserLogin::test_login_nonexistent_user PASSED                                        [ 31%]
tests/test_auth.py::TestUserLogin::test_login_missing_credentials PASSED                                     [ 34%]
tests/test_auth.py::TestUserLogin::test_login_extra_fields_rejected PASSED                                   [ 37%]
tests/test_auth.py::TestStrongPasswordEnforcement::test_password_too_short PASSED                            [ 41%]
tests/test_auth.py::TestStrongPasswordEnforcement::test_password_missing_uppercase PASSED                    [ 44%]
tests/test_auth.py::TestStrongPasswordEnforcement::test_password_missing_lowercase PASSED                    [ 48%]
tests/test_auth.py::TestStrongPasswordEnforcement::test_password_missing_digit PASSED                        [ 51%]
tests/test_auth.py::TestStrongPasswordEnforcement::test_password_special_character_missing PASSED            [ 55%]
tests/test_auth.py::TestStrongPasswordEnforcement::test_password_valid PASSED                                [ 58%]
tests/test_integration.py::TestIntegrationScenarios::test_complete_user_workflow PASSED                      [ 62%]
tests/test_integration.py::TestIntegrationScenarios::test_cross_user_access_denied_workflow PASSED           [ 65%]
tests/test_integration.py::TestIntegrationScenarios::test_password_validation_integration PASSED             [ 68%]
tests/test_integration.py::TestIntegrationScenarios::test_health_endpoint PASSED                             [ 72%]
tests/test_users.py::TestUserAccess::test_get_user_self_access PASSED                                        [ 75%]
tests/test_users.py::TestUserAccess::test_get_user_cross_access_forbidden PASSED                             [ 79%]
tests/test_users.py::TestUserAccess::test_get_user_unauthorized PASSED                                       [ 82%]
tests/test_users.py::TestUserAccess::test_get_user_invalid_token PASSED                                      [ 86%]
tests/test_users.py::TestUserAccess::test_get_user_nonexistent PASSED                                        [ 89%]
tests/test_users.py::TestUserAccess::test_get_user_malformed_user_id PASSED                                  [ 93%]
tests/test_users.py::TestUserAccess::test_admin_can_access_any_user PASSED                                   [ 96%]
tests/test_users.py::TestUserAccess::test_admin_can_access_own_data PASSED                                   [100%]

================================================ 29 passed in 8.31s ================================================
```
</details>

### API Docs

- Redoc: http://127.0.0.1:8000/redoc
- Swagger: http://127.0.0.1:8000/docs

## Features Not Implemented

This section mentions functionality that is not implemented due to various reasons.

### Email Verification

- The service lacks ability to verify user's email at the time of registration. Ideally, the user should have to verify their email before they are allowed to login.
- This is not implemented because it requires infrastructure (or an external service like SNS or Twilio) to send emails. This has been left out for simplicity.

### Secret Store

- Tokens are signed and verified using private and public keys respectively. For simplicity, sample keys are stored locally with the service on the filesystem.
- Ideally, the keys should be stored securely in secret manager e.g: AWS Secrets Manager, Hashicorp Vault, etc. and read by the servcie at startup.
- This is not implemented as it requires additional infrastructure and implementation time.

### Infrastructure

Followng infrastructure is strongly recommended while running the service in production:

- Enforce rate limits at API gateway. The is needed for all endpoints, but especially for the user registration endpoint. Not having rate limits exposes the service to various attacks including user enumeration.
- A Web Application Firewall (WAF) will help guard against several threats like DDoS, malicious requests, geographical blocking etc.
- The service must be made available over HTTPS.
- The service should emit metrics (failed/successful login attempts, authorization failures, invalid tokens etc.) that can be used for observability - monitoring and alerting.
- These are not implemented as they require additional infrastructure and implementation time.

### Other Missing Security Features

- Suspend a user account for a certain duration for successively failing 'n' login attempts within a time window.
- Implement MFA.
- Current Authorization model is all-or-nothing where a role is either granted or not. This can be extended so that granular permissions can be managed within a role.
- These are not implemented due to time constraints. They also require additional infrastructures.
